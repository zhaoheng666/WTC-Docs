# DH资源异常-manifest和文件访问预警

## 摘要

| | |
|-|-|
| **状态** | ✅ 已解决 |
| **日期** | 2025年11月10日 |
| **游戏** | DoubleHit (DH) |
| **问题资源** | `coupon_board_cv_2024_turkey_likeclg_20240927193848` |
| **根本原因** | CDN链接不一致：运营后台用current_version，游戏用版本号链接 |
| **解决方案** | 每次发版时过期current_version，保证一致性 |
| **原文档** | [飞书文档](https://ghoststudio.feishu.cn/wiki/GgllwsRQ4iz1sWkswp8cOtJYnfb) |

## 监控截图

![数数监控预警](/assets/e7ec9bfa6cb232ddb509450399f1ad90.png)

*数数科技监控显示manifest和文件访问异常激增*

![问题资源详情](/assets/db67dddf2342b2c49e6f0f768089d0aa.png)

*资源访问异常的具体数据*

![运营后台资源列表](/assets/1d2c852e37f86ee69b1027effccf6fa7.png)

*运营后台仍能看到已删除的资源*

## 问题现象

数数监控在 2025年11月10日 02:00-03:00 (UTC+0) 时段检测到 DoubleHit 游戏的资源访问异常激增。

**监控数据**：

| 预警项 | 分析对象 | 监控值 | 对比值 | 增长率 |
|-------|---------|--------|--------|--------|
| manifest文件访问异常 | ResourceUpdate.触发用户数 | 578 | 17 | 3300% |
| 文件访问异常 | ResAssetError.触发用户数 | 539 | 12 | 4391.67% |

**问题资源**：`coupon_board_cv_2024_turkey_likeclg_20240927193848`

## 排查过程

### 2025年11月10日 11:00-11:15

**马新蓝** 11:06：
- 识别问题资源：`coupon_board_cv_2024_turkey_likeclg_20240927193848`
- 判断：引流board资源，应该是运营那边传的

**赵恒** 11:15：
- 市场应该是直接使用了去年已经用过的配置，误认为线上资源还在
- @王建 @代云超：看下能不能给运营后台加个资源检查，coupon发布时给个"资源不存在"的提示

**代云超** 11:18：
- 这个稍微晚点我来看看能不能加一个提示吧

**马新蓝** 11:23：
- 我新传的资源：`coupon_board_cv_2024_turkey_likeclg_20251110111330`

### 2025年11月11日 16:46-17:46

**代云超** 16:46：
- 无效的Coupon的这个资源是怎么发出来的呢

**赵恒**：
- 我看了下，这个链接是来自我们的CDN呢，那说明资源应该是一直存在的吧
- 这种就没办法做数据不存在的提示，如果CDN上没有的话，这里的图片应该也看不到

**王建** 17:37：
- 找到了超哥，**运营平台用的是cdn链接是current_version，实际游戏里用的是cdn链接发版版本号路径的资源**
- **游戏版本号的资源如果资源服没有在下次过期时候cdn链接就失效了，但是current_version因为没有过期，就一直还能访问**

**代云超** 17:45：
- 额 每次发版还要改运营平台的版本?

**赵恒** 17:45：
- **不用，以后每次发版的时候过期下 current_version，保证运营平台拿到的资源和游戏拿到的资源一致**

**代云超** 17:46：
- 嗯，我觉赵哥这个方式好

## 根本原因

### 问题 1：CDN链接不一致（核心问题）

**现状**：
- **运营后台**：使用 `current_version` CDN链接
- **游戏客户端**：使用包含具体版本号的CDN链接（如 `v1.2.3/...`）

**问题机制**：
1. 发版时只过期了游戏客户端使用的版本号链接
2. **没有过期 `current_version` 链接**
3. 导致当前版本中已经移除的资源，在运营平台上通过 `current_version` 仍能访问
4. 运营人员看到"可访问"的资源，误认为线上还存在
5. 运营发布了包含已删除资源的 coupon
6. 玩家收到coupon，但游戏客户端通过版本号链接无法访问资源
7. 触发大量 manifest 文件访问异常和文件访问异常

**示例**：
```
运营后台看到的：
https://cdn.example.com/current_version/coupon_board_cv_2024_turkey_likeclg_20240927193848.png
→ 可访问（因为没过期）

游戏客户端尝试访问：
https://cdn.example.com/v1.2.3/coupon_board_cv_2024_turkey_likeclg_20240927193848.png
→ 404（资源已删除且链接已过期）
```

### 问题 2：时间戳一致性要求

动态资源发布时，以下三处的时间戳必须一致：
1. **资源文件名**：`coupon_board_cv_2024_turkey_likeclg_20240927193848`
2. **ccbi 文件中**：内部引用的时间戳
3. **coupon 数据**：发给玩家的 coupon 配置中的时间戳

**如果不一致**：即使资源存在，也会因为路径不匹配导致加载失败。

## 解决方案

### 短期方案（已实施）

**马新蓝** 重新上传资源：
- 新资源：`coupon_board_cv_2024_turkey_likeclg_20251110111330`
- 确保资源在当前版本中存在

### 长期方案（已确定）

**赵恒提出的方案**（已被采纳）：

**每次发版时同时过期 `current_version` CDN链接**

**实施步骤**：
1. 发版时不仅过期游戏客户端使用的版本号链接（如 `v1.2.3/...`）
2. **同时过期 `current_version` 链接**
3. 保证运营平台拿到的资源列表和游戏客户端能访问的资源列表完全一致

**效果**：
- ✅ 运营平台无法访问已删除的资源
- ✅ 避免运营人员发布无效的coupon
- ✅ 从根本上杜绝此类问题

**优势**：
- 不需要修改运营平台的版本管理
- 不需要在运营后台添加复杂的资源存在性检查
- 简单、直接、可靠

## 测试验证

- ✅ 新资源上传成功
- ✅ 监控数据恢复正常
- ⏳ 待下次发版验证 `current_version` 过期机制

## 涉及人员

- **马新蓝**：问题发现、资源重传
- **赵恒**：问题分析、方案制定
- **王建**：根本原因定位（CDN链接不一致）
- **代云超**：方案讨论、确认

## 经验总结

### 关键发现

1. **CDN链接管理的一致性至关重要**
   - 运营后台和游戏客户端必须访问相同的资源集合
   - 链接过期策略要覆盖所有使用场景

2. **动态资源的时间戳管理**
   - 资源名、ccbi、coupon数据中的时间戳必须完全一致
   - 任何一处不匹配都会导致加载失败

3. **监控的价值**
   - 数数监控及时发现异常激增
   - 3300%和4391.67%的增长率明确指向严重问题

### 预防措施

1. **发版流程改进**
   - 在发版checklist中明确：同时过期版本号链接和 `current_version` 链接
   - 编写自动化脚本确保不遗漏

2. **运营培训**
   - 告知运营人员不要复用旧的资源配置
   - 每次活动都使用新上传的资源

3. **资源管理规范**
   - 建立资源生命周期管理机制
   - 清晰标注资源的有效版本范围
