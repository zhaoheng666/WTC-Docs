# æ´»åŠ¨èµ„æºä¼˜åŒ– - åç½®åŠ è½½æ–¹æ¡ˆ

## æ¦‚è¿°

ä¸ºäº†ä¼˜åŒ–è¿›å…¥å¤§å…çš„åŠ è½½é€Ÿåº¦ï¼Œå°†éƒ¨åˆ†æ´»åŠ¨èµ„æºä»é¢„åŠ è½½æ”¹ä¸ºåç½®åŠ è½½ã€‚ç©å®¶è¿›å…¥å¤§å…åï¼Œè¿™äº›æ´»åŠ¨æ˜¾ç¤ºåŠ è½½å ä½ç¬¦ï¼Œèµ„æºåœ¨åå°ä¸‹è½½å®Œæˆåè‡ªåŠ¨æ›¿æ¢ä¸ºå®é™…å…¥å£ã€‚

---

## å½“å‰æ¶æ„ï¼ˆv2.0 - äº‹ä»¶é©±åŠ¨ï¼‰

> **é‡æ„æ—¥æœŸ**ï¼š2025-10-24
> **æäº¤å“ˆå¸Œ**ï¼še8b62e66889
> **å®Œæ•´å·¥ä½œè®°å½•**ï¼š[WTC èµ„æºåŠ è½½ä¼˜åŒ–ä»»åŠ¡è·Ÿè¸ª](/å…¶ä»–/å·¥ä½œè®°å½•/WTC-res-load-improve)

### æ¶æ„åŸåˆ™

âœ… **ä¾èµ–å€’ç½®** - èµ„æºå±‚ä¸ä¾èµ– UI å±‚
âœ… **èŒè´£åˆ†ç¦»** - èµ„æºå±‚è´Ÿè´£ä¸‹è½½ï¼ŒUI å±‚è´Ÿè´£æ˜¾ç¤º
âœ… **äº‹ä»¶é©±åŠ¨** - é€šè¿‡äº‹ä»¶å®ç°å®Œå…¨è§£è€¦
âœ… **ç”Ÿå‘½å‘¨æœŸå®‰å…¨** - æ— è·¨å±‚å¼•ç”¨ï¼Œæ— é‡æŒ‡é’ˆé£é™©

### æ¨¡å—ç»“æ„

```
ActivityDownloader (src/common/resource_v2/downloaders/)
  â”œâ”€ èŒè´£ï¼šçº¯èµ„æºä¸‹è½½é€»è¾‘
  â”œâ”€ è¾“å…¥ï¼šæ´»åŠ¨ä¿¡æ¯æ•°ç»„ [{activityId, themeName, ...}]
  â”œâ”€ è¾“å‡ºï¼šäº‹ä»¶é€šçŸ¥ï¼ˆDOWNLOAD_START / DOWNLOAD_COMPLETEï¼‰
  â””â”€ ç‰¹ç‚¹ï¼šå®Œå…¨ä¸æ¶‰åŠ UIï¼Œä¸æŒæœ‰ä»»ä½• Node å¼•ç”¨

ResourceManV2 (src/common/resource_v2/)
  â”œâ”€ ç»Ÿä¸€èµ„æºä¸‹è½½å…¥å£
  â””â”€ downloadActivities(activities) - è°ƒåº¦ ActivityDownloader

ActivityMan (src/task/model/)
  â”œâ”€ getLagLoadActivities() - è¿”å›æ´»åŠ¨ä¿¡æ¯æ•°ç»„
  â”œâ”€ downloadLagLoadActivities() - è§¦å‘ä¸‹è½½
  â””â”€ createLagLoadActivityPlaceholders() - [å·²åºŸå¼ƒ] ä¿ç•™å…¼å®¹

ActivityEntranceGroupController (src/task/controller/activity_center/)
  â”œâ”€ èŒè´£ï¼šå®Œå…¨æ¥ç®¡ Placeholder ç”Ÿå‘½å‘¨æœŸç®¡ç†
  â”œâ”€ ç›‘å¬ï¼šACTIVITY_RESOURCE_DOWNLOAD_START
  â”œâ”€ ç›‘å¬ï¼šACTIVITY_RESOURCE_DOWNLOAD_COMPLETE
  â”œâ”€ _placeholderMap - ç®¡ç† placeholder å¼•ç”¨
  â”œâ”€ _onActivityDownloadStart() - åˆ›å»º placeholder
  â””â”€ _onActivityDownloadComplete() - ç§»é™¤ placeholderï¼Œåˆ›å»ºçœŸå®å…¥å£
```

### äº‹ä»¶é©±åŠ¨æµç¨‹

```
ActivityEntranceGroupController (UIå±‚)
  â”‚
  â”œâ”€ onEnter()
  â”‚   â”œâ”€ ç›‘å¬ ACTIVITY_RESOURCE_DOWNLOAD_START
  â”‚   â””â”€ ç›‘å¬ ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE
  â”‚
  â”œâ”€ _startLagLoadActivityDownload()
  â”‚   â””â”€ ActivityMan.downloadLagLoadActivities()
  â”‚        â””â”€ ResourceManV2.downloadActivities(activities)
  â”‚             â””â”€ ActivityDownloader.download(activities)
  â”‚                  â”œâ”€ ğŸ”” å‘é€ DOWNLOAD_START äº‹ä»¶
  â”‚                  â”œâ”€ æ‰§è¡Œä¸‹è½½
  â”‚                  â””â”€ ğŸ”” å‘é€ DOWNLOAD_COMPLETE äº‹ä»¶
  â”‚
  â”œâ”€ _onActivityDownloadStart(event) â† ç›‘å¬åˆ°äº‹ä»¶
  â”‚   â”œâ”€ åˆ›å»º placeholder (UIæ“ä½œ)
  â”‚   â””â”€ ä¿å­˜åˆ° _placeholderMap
  â”‚
  â””â”€ _onActivityDownloadComplete(event) â† ç›‘å¬åˆ°äº‹ä»¶
      â”œâ”€ ä» _placeholderMap è·å– placeholder
      â”œâ”€ ç§»é™¤ placeholder (UIæ“ä½œ)
      â”œâ”€ åˆ›å»ºçœŸå®å…¥å£ (UIæ“ä½œ)
      â””â”€ è§¦å‘å¸ƒå±€æ›´æ–°
```

### äº‹ä»¶å®šä¹‰

**ä½ç½®**ï¼š`src/common/events/CommonEvent.js`

```javascript
// å•ä¸ªæ´»åŠ¨èµ„æºä¸‹è½½å¼€å§‹ï¼ˆUIå±‚ç›‘å¬ï¼‰
ACTIVITY_RESOURCE_DOWNLOAD_START: "activity_resource_download_start"

// å•ä¸ªæ´»åŠ¨èµ„æºä¸‹è½½å®Œæˆï¼ˆUIå±‚ç›‘å¬ï¼‰
ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE: "activity_resource_download_complete"
```

**äº‹ä»¶æ•°æ®æ ¼å¼**ï¼š

```javascript
// DOWNLOAD_START äº‹ä»¶æ•°æ®
{
    activityInfo: {
        activityId: string,
        activityName: string,
        themeName: string,
        activityTag: number
    }
}

// DOWNLOAD_COMPLETE äº‹ä»¶æ•°æ®
{
    activityInfo: {
        activityId: string,
        activityName: string,
        themeName: string,
        isSuccess: boolean  // ä¸‹è½½æ˜¯å¦æˆåŠŸ
    }
}
```

### TypeScript ç±»å‹æ”¯æŒ

```typescript
// ActivityDownloader.d.ts
interface ActivityInfo {
    activityId: string;
    activityName: string;
    themeName: string;
    activityTag?: number;
    isSilentLoad?: boolean;
    lagLoadPriority?: number;
}

class ActivityDownloader extends BaseDownloader {
    constructor();
    download(activities: ActivityInfo[]): void;
}

// ResourceManV2.d.ts
class ResourceManV2 {
    downloadActivities(activities: ActivityInfo[]): void;
}
```

---

## å…³é”®ä»£ç ä½ç½®

| æ¨¡å— | è·¯å¾„ | å…³é”®æ–¹æ³• |
|------|------|---------| | ActivityDownloader | `src/common/resource_v2/downloaders/ActivityDownloader.js` | `download()`, `_onDownloadComplete()` |
| ResourceManV2 | `src/common/resource_v2/ResourceManV2.js` | `downloadActivities()` |
| ActivityMan | `src/task/model/ActivityMan.js` | `getLagLoadActivities()`, `downloadLagLoadActivities()` |
| ActivityEntranceGroupController | `src/task/controller/activity_center/ActivityEntranceGroupController.js` | `_onActivityDownloadStart()`, `_onActivityDownloadComplete()` |
| äº‹ä»¶å®šä¹‰ | `src/common/events/CommonEvent.js` | `ACTIVITY_RESOURCE_DOWNLOAD_START`, `ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE` |
| ç±»å‹å®šä¹‰ | `src/common/resource_v2/downloaders/ActivityDownloader.d.ts` | TypeScript æ¥å£ |

---

## é…ç½®è¯´æ˜

### æ´»åŠ¨æ ‡è®°

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `isSilentLoad` | Boolean | æ˜¯å¦é™é»˜åŠ è½½ï¼ˆä¸æ˜¾ç¤ºå ä½ç¬¦ï¼‰ |
| `activityTag` | Number | å…¥å£èŠ‚ç‚¹çš„ tag å€¼ |
| `lagLoadPriority` | Number | åç½®åŠ è½½ä¼˜å…ˆçº§ï¼ˆæ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼‰ |

### ä¼˜å…ˆçº§è§„èŒƒ

**é…ç½®ä½ç½®**ï¼š`res_oldvegas/flavor/js_src/task/model/ActivityConfig.json`

| ä¼˜å…ˆçº§èŒƒå›´ | åˆ†ç±» | å…¸å‹æ´»åŠ¨ |
|----------|------|---------|
| **90** | æ ¸å¿ƒç³»ç»Ÿæ´»åŠ¨ | SystemCasinoChallenge, SystemDailyMission, SystemMedalRush |
| **101-102** | é«˜ä¼˜å…ˆçº§æ´»åŠ¨ | BingoIsland, Badges, GrowUpBounty, PigPower |
| **110-120** | é‡è¦æ´»åŠ¨ | CollectCity, HotSpin, SurprisePackage, PosterCenter |
| **130-150** | æ™®é€šæ´»åŠ¨ | LuckyDraw, Season, AlbumCatcher ç­‰ |
| **160-190** | ä½ä¼˜å…ˆçº§æ´»åŠ¨ | VideoReward, Guide ç­‰è¾…åŠ©åŠŸèƒ½ |

**é…ç½®å»ºè®®**ï¼š
- æ ¸å¿ƒç³»ç»Ÿæ´»åŠ¨ä¼˜å…ˆçº§æœ€é«˜ï¼ˆ90ï¼‰ï¼Œç¡®ä¿æœ€å…ˆåŠ è½½
- ç”¨æˆ·é«˜é¢‘äº¤äº’çš„æ´»åŠ¨è®¾ç½®é«˜ä¼˜å…ˆçº§ï¼ˆ101-120ï¼‰
- è¾…åŠ©åŠŸèƒ½å’Œå¼•å¯¼ç±»æ´»åŠ¨è®¾ç½®ä½ä¼˜å…ˆçº§ï¼ˆ160-190ï¼‰
- é¢„ç•™ä¼˜å…ˆçº§åŒºé—´ï¼Œä¾¿äºåç»­æ’å…¥æ–°æ´»åŠ¨

### ä½¿ç”¨ç¤ºä¾‹

```javascript
// éœ€è¦å ä½ç¬¦çš„æ´»åŠ¨
var activity = {
    activityId: "badges_2025",
    activityName: "Badges Event",
    themeName: "badges_2025",
    isSilentLoad: false,  // æ˜¾ç¤ºå ä½ç¬¦
    activityTag: 1001,
    lagLoadPriority: 150
};

// é™é»˜åŠ è½½çš„æ´»åŠ¨
var silentActivity = {
    activityId: "guide_activity",
    activityName: "Guide Activity",
    themeName: "guide",
    isSilentLoad: true,   // ä¸æ˜¾ç¤ºå ä½ç¬¦
    activityTag: 1002,
    lagLoadPriority: 200
};
```

---

## è¡¥å•å»¶è¿ŸåŠ è½½æœºåˆ¶

### èƒŒæ™¯

æ´»åŠ¨é‡‡ç”¨å»¶è¿ŸåŠ è½½ç­–ç•¥åï¼ˆinitActivity å’Œ startActivity åˆ†ç¦»ï¼‰ï¼Œè¡¥å•ï¼ˆverify purchaseï¼‰å¯èƒ½åœ¨æ´»åŠ¨èµ„æºæœªåŠ è½½æ—¶è§¦å‘ï¼Œå¯¼è‡´è¡¥å•ç•Œé¢æ— æ³•æ­£å¸¸æ˜¾ç¤ºã€‚

### è§£å†³æ–¹æ¡ˆ

é€šè¿‡æ–°å¢ä¸“ç”¨äº‹ä»¶å’Œå»¶è¿Ÿå›è°ƒæœºåˆ¶ï¼Œç¡®ä¿è¡¥å•æ—¶æ´»åŠ¨èµ„æºå·²åŠ è½½ã€‚

### æ ¸å¿ƒç»„ä»¶

#### 1. æ–°å¢äº‹ä»¶

**ä½ç½®**ï¼š`src/task/enum/ActivityNoticeType.js`

```javascript
// å»¶è¿ŸåŠ è½½æ´»åŠ¨çš„è¡¥å•ä¸“ç”¨äº‹ä»¶
NOTICE_VERIFY_PURCHASE_FOR_LOG_LOAD_ACTIVITY: 112
```

#### 2. å»¶è¿ŸåŠ è½½è¡¥å•å›è°ƒ

**ä½ç½®**ï¼š`src/task/entity/BaseActivity.js`

```javascript
/**
 * å»¶è¿ŸåŠ è½½è¡¥å•å›è°ƒï¼ˆèµ„æºåŠ è½½å®Œæˆåè°ƒç”¨ï¼‰
 * @param {*} args - è¡¥å•å‚æ•°
 */
onVerifyPurchaseWithLagLoaing: function(args) {
    'use strict';
    // 1. ç¡®ä¿èµ„æºå·²åŠ è½½
    this.startActivity();

    // 2. è°ƒç”¨åŸæœ‰è¡¥å•å›è°ƒ
    this.onVerifyPurchase(args);
}
```

#### 3. äº‹ä»¶ç›‘å¬å™¨ä¿æŠ¤

**ä½ç½®**ï¼š`src/task/model/ActivityMan.js`

```javascript
// æ•°æ®åˆ·æ–°æ—¶ä¿æŠ¤è¡¥å•äº‹ä»¶ç›‘å¬å™¨
_refreshActivityData: function() {
    'use strict';
    // ç§»é™¤æ—§äº‹ä»¶ç›‘å¬å™¨ï¼ˆæ’é™¤è¡¥å•äº‹ä»¶ï¼‰
    this._eventTarget.removeAllListeners(function(eventType) {
        return eventType !== ActivityNoticeType.NOTICE_VERIFY_PURCHASE_FOR_LOG_LOAD_ACTIVITY;
    });

    // é‡æ–°æ³¨å†Œæ´»åŠ¨äº‹ä»¶ç›‘å¬å™¨
    // ...
}
```

### å·¥ä½œæµç¨‹

```
StoreMan è¡¥å•è§¦å‘
  â”‚
  â”œâ”€ å‘é€ NOTICE_VERIFY_PURCHASE_FOR_LOG_LOAD_ACTIVITY äº‹ä»¶
  â”‚   â””â”€ noticeParams: {activityId, ...}
  â”‚
  â†“
BaseActivity æ¥æ”¶äº‹ä»¶
  â”‚
  â”œâ”€ onVerifyPurchaseWithLagLoaing(args)
  â”‚   â”œâ”€ 1. this.startActivity() â†’ ç¡®ä¿èµ„æºåŠ è½½
  â”‚   â”‚    â””â”€ å¦‚æœæœªåŠ è½½ï¼Œè§¦å‘èµ„æºåŠ è½½æµç¨‹
  â”‚   â”‚
  â”‚   â””â”€ 2. this.onVerifyPurchase(args) â†’ è°ƒç”¨åŸæœ‰è¡¥å•é€»è¾‘
  â”‚        â””â”€ æ˜¾ç¤ºè¡¥å•ç•Œé¢
  â”‚
  â””â”€ è¡¥å•å®Œæˆ
```

### å…³é”®ä»£ç ä½ç½®

| æ¨¡å— | è·¯å¾„ | å…³é”®æ–¹æ³• |
|------|------|---------|
| StoreMan | `src/store/model/StoreMan.js` | `verifyPurchase()` - å‘é€è¡¥å•äº‹ä»¶ |
| BaseActivity | `src/task/entity/BaseActivity.js` | `onVerifyPurchaseWithLagLoaing()` - å»¶è¿ŸåŠ è½½è¡¥å•å›è°ƒ |
| ActivityNoticeType | `src/task/enum/ActivityNoticeType.js` | `NOTICE_VERIFY_PURCHASE_FOR_LOG_LOAD_ACTIVITY` - äº‹ä»¶å®šä¹‰ |
| ActivityMan | `src/task/model/ActivityMan.js` | `_refreshActivityData()` - äº‹ä»¶ç›‘å¬å™¨ä¿æŠ¤ |

### å…¼å®¹æ€§è¯´æ˜

- âœ… å‘åå…¼å®¹ï¼šæ—§çš„ `NOTICE_VERIFY_PURCHASE` äº‹ä»¶ä»ç„¶å­˜åœ¨
- âœ… æ•°æ®å…¼å®¹ï¼šä¼˜åŒ–äº† `isCustomDataValid()` çš„ funcType åˆ¤æ–­ï¼Œå…¼å®¹å†å²æ´»åŠ¨æ•°æ®ï¼ˆfuncType ä¸ºç©ºï¼‰
- âœ… åŒäº‹ä»¶å…±å­˜ï¼šå»¶è¿ŸåŠ è½½æ´»åŠ¨ä½¿ç”¨æ–°äº‹ä»¶ï¼Œæ™®é€šæ´»åŠ¨ä»ä½¿ç”¨æ—§äº‹ä»¶

### è°ƒè¯•æŠ€å·§

**å…³é”®æ—¥å¿—**ï¼š

```javascript
// StoreMan
"[StoreMan] verifyPurchase: Triggering lag-load activity purchase verify"

// BaseActivity
"[BaseActivity] onVerifyPurchaseWithLagLoaing: Start loading resources for activity:"
"[BaseActivity] onVerifyPurchaseWithLagLoaing: Resources loaded, calling original callback"
```

### å¸¸è§é—®é¢˜æ’æŸ¥

1. **è¡¥å•ç•Œé¢æ— æ³•æ˜¾ç¤º** â†’ æ£€æŸ¥æ´»åŠ¨æ˜¯å¦æ­£ç¡®é…ç½®äº† `lagLoadPriority`
2. **è¡¥å•äº‹ä»¶è¢«æ¸…ç†** â†’ æ£€æŸ¥ `ActivityMan._refreshActivityData()` æ˜¯å¦æ­£ç¡®ä¿æŠ¤äº†è¡¥å•äº‹ä»¶
3. **funcType éªŒè¯å¤±è´¥** â†’ æ£€æŸ¥æ´»åŠ¨æ•°æ®ä¸­çš„ funcType å­—æ®µæ˜¯å¦æ­£ç¡®

---

## ç»´æŠ¤å»ºè®®

### æ—¥å¸¸ç»´æŠ¤

1. âœ… æ–°æ´»åŠ¨éœ€æ˜ç¡®é…ç½® `isSilentLoad` æ ‡å¿—
2. âœ… UI å±‚ï¼ˆActivityEntranceGroupControllerï¼‰è´Ÿè´£ç›‘å¬ä¸‹è½½äº‹ä»¶
3. âœ… èµ„æºå±‚ï¼ˆActivityDownloaderï¼‰åªè´Ÿè´£ä¸‹è½½ï¼Œä¸æ¶‰åŠ UI
4. âœ… æµ‹è¯•æ—¶æ³¨æ„è§‚å¯Ÿäº‹ä»¶è§¦å‘å’Œ placeholder ç”Ÿå‘½å‘¨æœŸ

### è°ƒè¯•æŠ€å·§

**å…³é”®æ—¥å¿—**ï¼š

```javascript
// ActivityEntranceGroupController
"[ActivityEntranceGroupController] Starting lag-load activity download, count:"
"[ActivityEntranceGroupController] Creating placeholder for:"
"[ActivityEntranceGroupController] Replacing placeholder with real entrance:"

// ActivityDownloader
"[ActivityDownloader] download: Start batch download, total activities:"
"[ActivityDownloader] _onDownloadComplete: Success, themeName:"
```

### å¸¸è§é—®é¢˜æ’æŸ¥

1. **å ä½ç¬¦æœªåˆ›å»º** â†’ æ£€æŸ¥ `isSilentLoad` é…ç½®å’Œäº‹ä»¶ç›‘å¬
2. **ä¸‹è½½å®Œæˆåæœªæ›¿æ¢** â†’ æ£€æŸ¥ `ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE` äº‹ä»¶æ˜¯å¦æ­£ç¡®è§¦å‘
3. **æ´»åŠ¨æœªæ¿€æ´»** â†’ æ£€æŸ¥ `ActivityMan._activateLagLoadActivity()` æ˜¯å¦è¢«è°ƒç”¨

---

## æ€§èƒ½æŒ‡æ ‡

- **é¦–æ¬¡è¿›å…¥å¤§å…åŠ è½½æ—¶é—´**ï¼šå‡å°‘çº¦ 30-50%ï¼ˆå–å†³äºåç½®åŠ è½½æ´»åŠ¨æ•°é‡ï¼‰
- **åå°ä¸‹è½½æ—¶é—´**ï¼šçº¦ 2-5 ç§’ï¼ˆå–å†³äºç½‘ç»œå’Œèµ„æºå¤§å°ï¼‰
- **å¹¶å‘ä¸‹è½½æ•°**ï¼šç”± ResourceManV2 æ§åˆ¶ï¼ˆé»˜è®¤ 3-5 ä¸ªï¼‰

---

## å†å²æ¶æ„è¯´æ˜

### v1.0 æ¶æ„ï¼ˆå·²åºŸå¼ƒï¼‰

v1.0 æ¶æ„å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼Œå·²åœ¨ v2.0 ä¸­å®Œå…¨é‡æ„ï¼š

- âŒ èµ„æºå±‚ï¼ˆActivityResourceDownloadManagerï¼‰ç›´æ¥æŒæœ‰ UI å±‚çš„ Node å¼•ç”¨
- âŒ èµ„æºå±‚è´Ÿè´£åˆ›å»ºå’Œç®¡ç† placeholderï¼ˆè¿åå•ä¸€èŒè´£ï¼‰
- âŒ å­˜åœ¨è·¨å±‚å¼•ç”¨å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†é£é™©

**å½“å‰çŠ¶æ€**ï¼š
- âš ï¸ ä¸å»ºè®®ç»§ç»­ä½¿ç”¨ `createLagLoadActivityPlaceholders()` æ¥å£
- âš ï¸ è¯¥æ¥å£å·²åºŸå¼ƒï¼Œä¿ç•™ä»…ä¸ºå‘åå…¼å®¹
- âœ… æ–°ä»£ç åº”ä½¿ç”¨ `downloadLagLoadActivities()` æ¥å£

è¯¦ç»†çš„æ¶æ„æ¼”è¿›è¿‡ç¨‹å’ŒæŠ€æœ¯å†³ç­–ï¼Œè¯·å‚è€ƒï¼š[WTC èµ„æºåŠ è½½ä¼˜åŒ–ä»»åŠ¡è·Ÿè¸ª](/å…¶ä»–/å·¥ä½œè®°å½•/WTC-res-load-improve)

---

**æœ€åæ›´æ–°**ï¼š2025-10-24
**æ¶æ„ç‰ˆæœ¬**ï¼šv2.0ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰
**ç»´æŠ¤è€…**ï¼šWTC Team
