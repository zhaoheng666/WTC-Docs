# 活动资源优化 - 后置加载方案

## 概述

为了优化进入大厅的加载速度，将部分活动资源从预加载改为后置加载。玩家进入大厅后，这些活动显示加载占位符，资源在后台下载完成后自动替换为实际入口。

---

## 当前架构（v2.0 - 事件驱动）

> **重构日期**：2025-10-24
> **提交哈希**：e8b62e66889
> **完整工作记录**：[WTC 资源加载优化任务跟踪](/其他/工作记录/WTC-res-load-improve)

### 架构原则

✅ **依赖倒置** - 资源层不依赖 UI 层
✅ **职责分离** - 资源层负责下载，UI 层负责显示
✅ **事件驱动** - 通过事件实现完全解耦
✅ **生命周期安全** - 无跨层引用，无野指针风险

### 模块结构

```
ActivityDownloader (src/common/resource_v2/downloaders/)
  ├─ 职责：纯资源下载逻辑
  ├─ 输入：活动信息数组 [{activityId, themeName, ...}]
  ├─ 输出：事件通知（DOWNLOAD_START / DOWNLOAD_COMPLETE）
  └─ 特点：完全不涉及 UI，不持有任何 Node 引用

ResourceManV2 (src/common/resource_v2/)
  ├─ 统一资源下载入口
  └─ downloadActivities(activities) - 调度 ActivityDownloader

ActivityMan (src/task/model/)
  ├─ getLagLoadActivities() - 返回活动信息数组
  ├─ downloadLagLoadActivities() - 触发下载
  └─ createLagLoadActivityPlaceholders() - [已废弃] 保留兼容

ActivityEntranceGroupController (src/task/controller/activity_center/)
  ├─ 职责：完全接管 Placeholder 生命周期管理
  ├─ 监听：ACTIVITY_RESOURCE_DOWNLOAD_START
  ├─ 监听：ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE
  ├─ _placeholderMap - 管理 placeholder 引用
  ├─ _onActivityDownloadStart() - 创建 placeholder
  └─ _onActivityDownloadComplete() - 移除 placeholder，创建真实入口
```

### 事件驱动流程

```
ActivityEntranceGroupController (UI层)
  │
  ├─ onEnter()
  │   ├─ 监听 ACTIVITY_RESOURCE_DOWNLOAD_START
  │   └─ 监听 ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE
  │
  ├─ _startLagLoadActivityDownload()
  │   └─ ActivityMan.downloadLagLoadActivities()
  │        └─ ResourceManV2.downloadActivities(activities)
  │             └─ ActivityDownloader.download(activities)
  │                  ├─ 🔔 发送 DOWNLOAD_START 事件
  │                  ├─ 执行下载
  │                  └─ 🔔 发送 DOWNLOAD_COMPLETE 事件
  │
  ├─ _onActivityDownloadStart(event) ← 监听到事件
  │   ├─ 创建 placeholder (UI操作)
  │   └─ 保存到 _placeholderMap
  │
  └─ _onActivityDownloadComplete(event) ← 监听到事件
      ├─ 从 _placeholderMap 获取 placeholder
      ├─ 移除 placeholder (UI操作)
      ├─ 创建真实入口 (UI操作)
      └─ 触发布局更新
```

### 事件定义

**位置**：`src/common/events/CommonEvent.js`

```javascript
// 单个活动资源下载开始（UI层监听）
ACTIVITY_RESOURCE_DOWNLOAD_START: "activity_resource_download_start"

// 单个活动资源下载完成（UI层监听）
ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE: "activity_resource_download_complete"
```

**事件数据格式**：

```javascript
// DOWNLOAD_START 事件数据
{
    activityInfo: {
        activityId: string,
        activityName: string,
        themeName: string,
        activityTag: number
    }
}

// DOWNLOAD_COMPLETE 事件数据
{
    activityInfo: {
        activityId: string,
        activityName: string,
        themeName: string,
        isSuccess: boolean  // 下载是否成功
    }
}
```

### TypeScript 类型支持

```typescript
// ActivityDownloader.d.ts
interface ActivityInfo {
    activityId: string;
    activityName: string;
    themeName: string;
    activityTag?: number;
    isSilentLoad?: boolean;
    lagLoadPriority?: number;
}

class ActivityDownloader extends BaseDownloader {
    constructor();
    download(activities: ActivityInfo[]): void;
}

// ResourceManV2.d.ts
class ResourceManV2 {
    downloadActivities(activities: ActivityInfo[]): void;
}
```

---

## 关键代码位置

| 模块 | 路径 | 关键方法 |
|------|------|---------| | ActivityDownloader | `src/common/resource_v2/downloaders/ActivityDownloader.js` | `download()`, `_onDownloadComplete()` |
| ResourceManV2 | `src/common/resource_v2/ResourceManV2.js` | `downloadActivities()` |
| ActivityMan | `src/task/model/ActivityMan.js` | `getLagLoadActivities()`, `downloadLagLoadActivities()` |
| ActivityEntranceGroupController | `src/task/controller/activity_center/ActivityEntranceGroupController.js` | `_onActivityDownloadStart()`, `_onActivityDownloadComplete()` |
| 事件定义 | `src/common/events/CommonEvent.js` | `ACTIVITY_RESOURCE_DOWNLOAD_START`, `ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE` |
| 类型定义 | `src/common/resource_v2/downloaders/ActivityDownloader.d.ts` | TypeScript 接口 |

---

## 配置说明

### 活动标记

| 字段 | 类型 | 说明 |
|------|------|------|
| `isSilentLoad` | Boolean | 是否静默加载（不显示占位符） |
| `activityTag` | Number | 入口节点的 tag 值 |
| `lagLoadPriority` | Number | 后置加载优先级 |

### 使用示例

```javascript
// 需要占位符的活动
var activity = {
    activityId: "badges_2025",
    activityName: "Badges Event",
    themeName: "badges_2025",
    isSilentLoad: false,  // 显示占位符
    activityTag: 1001,
    lagLoadPriority: 150
};

// 静默加载的活动
var silentActivity = {
    activityId: "guide_activity",
    activityName: "Guide Activity",
    themeName: "guide",
    isSilentLoad: true,   // 不显示占位符
    activityTag: 1002,
    lagLoadPriority: 200
};
```

---

## 维护建议

### 日常维护

1. ✅ 新活动需明确配置 `isSilentLoad` 标志
2. ✅ UI 层（ActivityEntranceGroupController）负责监听下载事件
3. ✅ 资源层（ActivityDownloader）只负责下载，不涉及 UI
4. ✅ 测试时注意观察事件触发和 placeholder 生命周期

### 调试技巧

**关键日志**：

```javascript
// ActivityEntranceGroupController
"[ActivityEntranceGroupController] Starting lag-load activity download, count:"
"[ActivityEntranceGroupController] Creating placeholder for:"
"[ActivityEntranceGroupController] Replacing placeholder with real entrance:"

// ActivityDownloader
"[ActivityDownloader] download: Start batch download, total activities:"
"[ActivityDownloader] _onDownloadComplete: Success, themeName:"
```

### 常见问题排查

1. **占位符未创建** → 检查 `isSilentLoad` 配置和事件监听
2. **下载完成后未替换** → 检查 `ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE` 事件是否正确触发
3. **活动未激活** → 检查 `ActivityMan._activateLagLoadActivity()` 是否被调用

---

## 性能指标

- **首次进入大厅加载时间**：减少约 30-50%（取决于后置加载活动数量）
- **后台下载时间**：约 2-5 秒（取决于网络和资源大小）
- **并发下载数**：由 ResourceManV2 控制（默认 3-5 个）

---

## 历史架构说明

### v1.0 架构（已废弃）

v1.0 架构存在以下问题，已在 v2.0 中完全重构：

- ❌ 资源层（ActivityResourceDownloadManager）直接持有 UI 层的 Node 引用
- ❌ 资源层负责创建和管理 placeholder（违反单一职责）
- ❌ 存在跨层引用和生命周期管理风险

**当前状态**：
- ⚠️ 不建议继续使用 `createLagLoadActivityPlaceholders()` 接口
- ⚠️ 该接口已废弃，保留仅为向后兼容
- ✅ 新代码应使用 `downloadLagLoadActivities()` 接口

详细的架构演进过程和技术决策，请参考：[WTC 资源加载优化任务跟踪](/其他/工作记录/WTC-res-load-improve)

---

**最后更新**：2025-10-24
**架构版本**：v2.0（事件驱动）
**维护者**：WTC Team
