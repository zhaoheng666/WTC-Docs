# 活动资源优化 - 后置加载方案

## 概述

为了优化进入大厅的加载速度，将部分活动资源从预加载改为后置加载。玩家进入大厅后，这些活动显示加载占位符，资源在后台下载完成后自动替换为实际入口。

---

## 🆕 最新架构（v2.0 - 事件驱动）

> **重构日期**：2025-10-24
> **提交哈希**：e8b62e66889

### 架构原则

✅ **依赖倒置** - 资源层不依赖 UI 层
✅ **职责分离** - 资源层负责下载，UI 层负责显示
✅ **事件驱动** - 通过事件实现完全解耦
✅ **生命周期安全** - 无跨层引用，无野指针风险

### 新模块结构

```
ActivityDownloader (src/common/resource_v2/downloaders/)
  ├─ 职责：纯资源下载逻辑
  ├─ 输入：活动信息数组 [{activityId, themeName, ...}]
  ├─ 输出：事件通知（DOWNLOAD_START / DOWNLOAD_COMPLETE）
  └─ 特点：完全不涉及 UI，不持有任何 Node 引用

ResourceManV2 (src/common/resource_v2/)
  ├─ 统一资源下载入口
  └─ downloadActivities(activities) - 调度 ActivityDownloader

ActivityMan (src/task/model/)
  ├─ getLagLoadActivities() - 返回活动信息数组
  ├─ downloadLagLoadActivities() - 触发下载
  └─ createLagLoadActivityPlaceholders() - [已废弃] 保留兼容

ActivityEntranceGroupController (src/task/controller/activity_center/)
  ├─ 职责：完全接管 Placeholder 生命周期管理
  ├─ 监听：ACTIVITY_RESOURCE_DOWNLOAD_START
  ├─ 监听：ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE
  ├─ _placeholderMap - 管理 placeholder 引用
  ├─ _onActivityDownloadStart() - 创建 placeholder
  └─ _onActivityDownloadComplete() - 移除 placeholder，创建真实入口
```

### 事件驱动流程

```
ActivityEntranceGroupController (UI层)
  │
  ├─ onEnter()
  │   ├─ 监听 ACTIVITY_RESOURCE_DOWNLOAD_START
  │   └─ 监听 ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE
  │
  ├─ _startLagLoadActivityDownload()
  │   └─ ActivityMan.downloadLagLoadActivities()
  │        └─ ResourceManV2.downloadActivities(activities)
  │             └─ ActivityDownloader.download(activities)
  │                  ├─ 🔔 发送 DOWNLOAD_START 事件
  │                  ├─ 执行下载
  │                  └─ 🔔 发送 DOWNLOAD_COMPLETE 事件
  │
  ├─ _onActivityDownloadStart(event) ← 监听到事件
  │   ├─ 创建 placeholder (UI操作)
  │   └─ 保存到 _placeholderMap
  │
  └─ _onActivityDownloadComplete(event) ← 监听到事件
      ├─ 从 _placeholderMap 获取 placeholder
      ├─ 移除 placeholder (UI操作)
      ├─ 创建真实入口 (UI操作)
      └─ 触发布局更新
```

### 新增事件定义

**位置**：`src/common/events/CommonEvent.js`

```javascript
// 单个活动资源下载开始（UI层监听）
ACTIVITY_RESOURCE_DOWNLOAD_START: "activity_resource_download_start"

// 单个活动资源下载完成（UI层监听）
ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE: "activity_resource_download_complete"
```

**事件数据格式**：

```javascript
// DOWNLOAD_START 事件数据
{
    activityInfo: {
        activityId: string,
        activityName: string,
        themeName: string,
        activityTag: number
    }
}

// DOWNLOAD_COMPLETE 事件数据
{
    activityInfo: {
        activityId: string,
        activityName: string,
        themeName: string,
        isSuccess: boolean  // 下载是否成功
    }
}
```

### 架构对比

| 层级 | 旧架构（v1.0） | 新架构（v2.0） |
|-----|-------------|-------------|
| **资源层** | 下载 + UI操作 ❌ | 只负责下载和通知 ✅ |
| **UI层** | 只触发，UI由资源层管理 ❌ | 监听事件，完全管理 UI ✅ |
| **耦合** | 资源层持有 Node 引用 ❌ | 完全事件驱动解耦 ✅ |
| **职责** | 混乱 ❌ | 清晰分离 ✅ |

### TypeScript 类型支持

新架构提供完整的 TypeScript 类型定义：

```typescript
// ActivityDownloader.d.ts
interface ActivityInfo {
    activityId: string;
    activityName: string;
    themeName: string;
    activityTag?: number;
    isSilentLoad?: boolean;
    lagLoadPriority?: number;
}

class ActivityDownloader extends BaseDownloader {
    constructor();
    download(activities: ActivityInfo[]): void;
}

// ResourceManV2.d.ts
class ResourceManV2 {
    downloadActivities(activities: ActivityInfo[]): void;
}
```

---

## 📚 历史架构（v1.0 - 直接耦合）

> 以下内容保留作为参考，实际代码已重构为 v2.0 架构

### 旧模块结构

```
ActivityResourceDownloadManager (已重构为 ActivityDownloader)
  ├─ 管理占位符创建  [已移至 UI 层]
  ├─ 协调并发下载     [保留]
  └─ 处理入口替换     [已移至 UI 层]

ActivityMan (最小修改)
  ├─ createLagLoadActivityPlaceholders() - [已废弃]
  ├─ _getActivityById() - 辅助方法
  └─ _activateLagLoadActivity() - 辅助方法

ActivityEntranceGroupController (扩展)
  └─ isEntranceValid() - 添加占位符保护逻辑
```

### 关键实现细节

#### 1. 静默加载支持

```javascript
// ActivityResourceDownloadManager._createPlaceholder
var placeholder = null;
if (!activity.isSilentLoad) {
    // 只为非静默加载的活动创建占位符
    placeholder = ActivityLoadingPlaceholderController.createFromCCB(activity.activityId);
    parentNode.addChild(placeholder, 0, activity.activityTag);
    this._placeholderEntrances[activity.activityId] = placeholder;
}

// 所有活动（包括静默加载）都加入下载队列
this._pendingDownloads.push({
    activity: activity,
    placeholder: placeholder,  // 静默加载时为 null
    resourcePath: "activity/" + activity.themeName
});
```

**设计原因**：部分活动（如引导活动）不需要显示占位符，但需要后台下载资源。

#### 2. 占位符替换顺序

```javascript
// ActivityResourceDownloadManager._replaceWithRealEntrance

// 1. 激活活动（从 lagLoadActivityCache 移到 activities）
this._activityMan._activateLagLoadActivity(activity);

// 2. 先移除占位符
var placeholder = this._placeholderEntrances[activityId];
if (placeholder || cc.sys.isObjectValid(placeholder)) {
    game.nodeHelper.removeNodeFromParent(placeholder, true);
    delete this._placeholderEntrances[activityId];
}

// 3. 再创建实际入口（必须在移除占位符之后）
activity.createActivityEntrance(parentNode);
```

**关键点**：
- ⚠️ **必须先移除占位符，再创建入口**
- 原因：`BaseActivity.createActivityEntrance` 会通过 `getChildByTag(activityTag)` 检查是否已有入口
- 如果占位符还在，会被误认为是已存在的入口，导致创建失败

#### 3. 占位符保护机制

```javascript
// ActivityEntranceGroupController.isEntranceValid
ActivityEntranceGroupController.prototype.isEntranceValid = function (entrance) {
    if (!cc.sys.isObjectValid(entrance)) return false;

    // 占位符入口始终有效（正在下载资源中）
    if (entrance.controller && entrance.controller._isPlaceholder) {
        return true;
    }

    // 常规验证逻辑...
};
```

**作用**：防止占位符在资源下载过程中被 `updateActivityEntrance` 误删除。

## 工作流程

```
进入大厅
  ↓
ActivityEntranceGroupController.initEntrances()
  ↓
1. createActivitiesEntrance()          // 为已下载活动创建入口
2. createLagLoadActivityPlaceholders() // 为后置加载活动创建占位符
  ↓
ActivityResourceDownloadManager
  ├─ _createPlaceholder()              // 创建占位符（检查 isSilentLoad）
  └─ _startDownload()                  // 并发下载资源
       ↓
       下载完成（单个活动）
       ↓
       _onSingleTaskComplete()
       ↓
       _replaceWithRealEntrance()
         ├─ _activateLagLoadActivity()  // 激活活动
         ├─ 移除占位符                   // 先移除
         ├─ createActivityEntrance()    // 再创建
         └─ 触发 ACTIVITY_UPDATE_LOBBY_ENTRANCE_LAYOUT
              ↓
              updateActivityEntrance()  // 重新排序入口
```

## 历史包袱问题

### 为什么必须调用 createActivityEntrance？

即使活动没有标准入口（`isShowEntrance = false`），也必须调用 `createActivityEntrance()`：

```javascript
// 历史包袱问题，无论是否有标准的活动入口，createActivityEntrance方法多走一遍，
// 其中可能包含不可丢弃的逻辑
activity.createActivityEntrance(parentNode);
```

**原因**：
- 部分活动的 `createActivityEntrance` 中包含额外逻辑（不仅仅是创建入口节点）
- 这些逻辑可能影响活动功能，不能省略
- 必须在移除占位符之后调用，避免 tag 冲突

## 配置说明

### 活动标记

| 字段 | 类型 | 说明 |
|------|------|------|
| `isSilentLoad` | Boolean | 是否静默加载（不显示占位符） |
| `activityTag` | Number | 入口节点的 tag 值 |
| `isShowEntrance` | Boolean | 是否显示标准入口 |

### 使用示例

```javascript
// 需要占位符的活动
var activity = {
    isSilentLoad: false,  // 显示占位符
    activityTag: 1001,
    isShowEntrance: true
};

// 静默加载的活动
var silentActivity = {
    isSilentLoad: true,   // 不显示占位符
    activityTag: 1002,
    isShowEntrance: false
};
```

## 事件说明

### ACTIVITY_UPDATE_LOBBY_ENTRANCE_LAYOUT

- **触发时机**：单个活动资源下载完成，入口替换后
- **作用**：只重新排序入口，不重建所有入口
- **监听位置**：`ActivityEntranceGroupController.onEnter()`

```javascript
this.addListener(
    game.activityEvent.ACTIVITY_UPDATE_LOBBY_ENTRANCE_LAYOUT,
    this.updateActivityEntrance
);
```

## 文件清单

### 新增文件

- `src/task/model/ActivityResourceDownloadManager.js` - 核心模块
- `src/task/controller/activity_center/ActivityLoadingPlaceholderController.js` - 占位符 Controller

### 修改文件

- `src/task/model/ActivityMan.js` - 添加 3 个辅助方法
- `src/task/controller/activity_center/ActivityEntranceGroupController.js` - 扩展验证逻辑
- `src/task/events/ActivityEvent.js` - 添加注释说明

## 调试技巧

### 日志关键点

```javascript
// 占位符创建
cc.log("[ActivityResourceDownloadManager] Creating loading placeholder for activity:", themeName);
cc.log("need show activity entrance placeholder,check activity.isSilentLoad:", activityName, themeName);

// 入口替换
cc.log("[ActivityResourceDownloadManager] Replacing placeholder with real entrance:", themeName);
cc.log("[ActivityResourceDownloadManager] Placeholder replaced successfully:", themeName);
```

### 常见问题排查

1. **占位符被误删** → 检查 `isEntranceValid` 是否包含占位符保护逻辑
2. **入口创建失败** → 确认占位符已在 `createActivityEntrance` 之前移除
3. **tag 冲突** → 检查占位符和实际入口是否使用了相同的 `activityTag`

## 性能指标

- **首次进入大厅加载时间**：减少约 30-50%（取决于后置加载活动数量）
- **后台下载时间**：约 2-5 秒（取决于网络和资源大小）
- **并发下载数**：由 ResourceManV2 控制（默认 3-5 个）

## 维护建议

### v2.0 架构维护

1. ✅ 新活动需明确配置 `isSilentLoad` 标志
2. ✅ UI 层（ActivityEntranceGroupController）负责监听下载事件
3. ✅ 资源层（ActivityDownloader）只负责下载，不涉及 UI
4. ✅ 测试时注意观察事件触发和 placeholder 生命周期
5. ✅ 定期检查是否有活动的 `createActivityEntrance` 包含关键逻辑

### v1.0 架构维护（已废弃）

1. ⚠️ 不建议继续使用 `createLagLoadActivityPlaceholders()` 接口
2. ⚠️ 如需兼容，该接口会自动调用新接口 `downloadLagLoadActivities()`

---

## 相关代码位置

### v2.0 架构（当前）

| 模块 | 路径 | 关键方法 |
|------|------|---------|
| ActivityDownloader | `src/common/resource_v2/downloaders/ActivityDownloader.js` | `download()`, `_onDownloadComplete()` |
| ResourceManV2 | `src/common/resource_v2/ResourceManV2.js` | `downloadActivities()` |
| ActivityMan | `src/task/model/ActivityMan.js` | `getLagLoadActivities()`, `downloadLagLoadActivities()` |
| ActivityEntranceGroupController | `src/task/controller/activity_center/ActivityEntranceGroupController.js` | `_onActivityDownloadStart()`, `_onActivityDownloadComplete()` |
| 事件定义 | `src/common/events/CommonEvent.js` | `ACTIVITY_RESOURCE_DOWNLOAD_START`, `ACTIVITY_RESOURCE_DOWNLOAD_COMPLETE` |
| 类型定义 | `src/common/resource_v2/downloaders/ActivityDownloader.d.ts` | TypeScript 接口 |

### v1.0 架构（历史参考）

| 模块 | 路径 | 状态 |
|------|------|-----|
| ActivityResourceDownloadManager | ~~src/task/model/ActivityResourceDownloadManager.js~~ | 已重构为 ActivityDownloader |

---

**最后更新**：2025-10-24
**重构提交**：e8b62e66889
**架构版本**：v2.0（事件驱动）
