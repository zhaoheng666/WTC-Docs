# 飞书集成规范

**适用范围**: docs 子项目文档生成

从飞书文档读取原始信息，加工后自动生成标准 Markdown 文档并提交到 docs 项目。

---

## lark-mcp 工具使用

### 前置条件

确保已正确配置 lark-mcp：

```bash
# 检查配置
claude mcp list | grep lark-mcp

# 如未配置，参考之前的配置步骤
# ~/.claude.json 中应包含 lark-mcp 配置，包含 App ID 和 Secret
```

### 工具调用

#### 1. 获取飞书 Wiki 节点信息

```javascript
mcp__lark-mcp__wiki_v2_space_getNode({
  params: {
    token: "FjqOwGH72izxYHkbgKgcUSEbnZb",  // Wiki Token
    obj_type: "wiki"
  },
  useUAT: true  // 可选，调试模式
})
```

**参数说明**：
- `token`: 从飞书链接提取，例如 `https://ghoststudio.feishu.cn/wiki/FjqOwGH72izxYHkbgKgcUSEbnZb` → token: `FjqOwGH72izxYHkbgKgcUSEbnZb`
- `obj_type`: 固定为 `wiki`

**返回信息**：
- `title`: 文档标题
- `children`: 子页面列表
- `document_id`: 文档 ID（用于读取内容）

---

#### 2. 读取文档原始内容

```javascript
mcp__lark-mcp__docx_v1_document_rawContent({
  path: {
    document_id: "XP5Md7Xa9ooFJRx4vALcnmHxn1b"  // 从 getNode 获得
  },
  params: {
    lang: 0  // 0=默认语言, 1=英文, 2=日文
  },
  useUAT: true  // 可选
})
```

**参数说明**：
- `document_id`: Wiki 节点的文档 ID
- `lang`: 语言参数

**返回信息**：
- `content`: 文档的 XML 格式内容
- 需要解析提取有用信息

---

#### 3. URL 转换

飞书文档的两种常见链接格式：

| 格式 | 示例 | 说明 |
|-----|------|------|
| 完整链接 | `https://ghoststudio.feishu.cn/wiki/FjqOwGH72izxYHkbgKgcUSEbnZb` | 可直接提取 token |
| 短链接 | `https://ghoststudio.feishu.cn/wiki/FjqOwGH72izxYHkbgKgcUSEbnZb?from=from_copylink` | 去除查询参数后提取 token |

**提取方法**：

```javascript
// 正则匹配提取 Wiki Token
const wikiTokenMatch = url.match(/\/wiki\/([a-zA-Z0-9]+)/);
const wikiToken = wikiTokenMatch ? wikiTokenMatch[1] : null;
```

---

## 文档类型识别详细规则

### 关键词完整列表

#### 故障排查类关键词

**问题相关**：
- 问题、错误、异常、崩溃、不工作、失效、无法
- Bug、Issue、Crash、Exception、Error
- 故障、缺陷、问题、BUG

**排查相关**：
- 原因、排查、调试、根因、定位、分析
- Fix、Fixed、Solved、已解决、已修复、解决方案

**技术术语**：
- Null、Undefined、TypeError、ReferenceError
- 权限、权限不足、Access Denied、403、401
- 加载失败、连接超时、网络错误

#### 活动类关键词

**活动类型**：
- 活动、活动规则、活动设计、活动方案
- 签到、签到活动、每日签到
- 抽奖、幸运抽奖、转盘、刮刮卡
- 赛事、比赛、竞技、排行榜

**时间相关**：
- 时间、开始时间、结束时间、活动时间
- 奖励、奖励设置、奖励配置
- 兑换、礼品、参与条件

**玩法相关**：
- 规则、玩法、说明、参与、流程
- 等级、段位、阶段、限制条件

#### 关卡类关键词

**关卡相关**：
- 关卡、关卡设计、关卡配置、关卡说明
- 关卡 XXX、Level XX、Stage XX
- 难度、难度级别、等级、难度等级

**数值相关**：
- 数值、配置、参数、赔率、中奖率
- 玩法机制、机制描述、功能说明
- 倍数、倍率、概率、奖励倍数

**文件相关**：
- 文件、文件路径、文件列表、代码文件
- js、配置文件、json、xml

---

### 结构分析规则

#### 故障排查的典型结构

```
[问题标题/关键词]
  ↓
[问题描述] + [现象] + [触发条件]
  ↓
[根本原因分析] + [代码截图/文件位置]
  ↓
[解决方案] + [代码修改]
  ↓
[测试验证] + [测试结果]
  ↓
[完成标记] ✅ 已解决 / 🔄 处理中
```

**关键标志**：
- 包含"问题"和"异常"描述
- 包含"原因"或"根因"分析
- 包含"解决"或"修复"方案
- 包含"测试"或"验证"内容

#### 活动的典型结构

```
[活动名称]
  ↓
[基本信息] 时间 + 类型 + 对象
  ↓
[活动规则] 参与方式 + 约束条件
  ↓
[奖励设置] 等级奖励表 + 额度
  ↓
[玩法说明] 步骤化描述
  ↓
[时间规划] 各阶段时间表
```

**关键标志**：
- 包含"活动"和时间信息
- 包含"规则"或"说明"部分
- 包含"奖励"或"奖励表"
- 包含参与条件或限制

#### 关卡的典型结构

```
[关卡标题/编号]
  ↓
[基本属性] 关卡号 + 难度 + 类型
  ↓
[功能说明] 玩法机制描述
  ↓
[数值配置] 配置表格 + 参数列表
  ↓
[技术实现] 文件位置 + 代码引用
  ↓
[特殊说明] 注意事项 + 约束条件
```

**关键标志**：
- 包含"关卡"标识
- 包含"数值"或"配置"部分
- 包含"机制"或"玩法"描述
- 包含文件路径引用

---

## 信息提取规则

### 通用提取逻辑

对任何文档，按以下优先级提取关键信息：

1. **标题** → 第一个标题级别（#）
2. **副标题/描述** → 第一段文本或第二个标题
3. **关键表格** → 包含属性/状态的表格
4. **核心内容** → 按类型提取对应章节
5. **补充信息** → 时间、人员、决策等

### 类型特定提取

#### 故障排查提取

```
必提取：
- 问题现象（可合并"问题"+"触发场景"）
- 根本原因（一句话）
- 解决方案（简化）
- 测试结果（核心项）

可选提取：
- 提交记录 (Git Commit Hash)
- 文件位置 (filepath:line)
- 相关人员
```

#### 活动提取

```
必提取：
- 活动名称（可从标题或内容提取）
- 时间范围（开始 - 结束）
- 活动类型（签到/抽奖等）
- 奖励信息（表格或列表）

可选提取：
- 活动描述
- 参与条件
- 特殊说明
```

#### 关卡提取

```
必提取：
- 关卡标识（号码或名称）
- 难度等级
- 玩法机制（简化说明）
- 数值配置（表格）

可选提取：
- 相关文件
- 特殊配置
- 测试覆盖
```

---

## Markdown 生成详细指南

### 通用格式规范

```markdown
# 标题（一级）

## 章节（二级）

### 子章节（三级）

**粗体**: 重要概念
`代码`: 代码片段或参数

| 列 1 | 列 2 |
|------|------|
| 值 1 | 值 2 |

- 列表项 1
- 列表项 2

代码块：
\`\`\`language
code here
\`\`\`

链接：[文本](URL)
```

### 故障排查生成规则

```markdown
# [问题标题]

## 摘要

| | |
|-|-|
| **状态** | ✅ 已解决 / 🔄 处理中 / ❌ 未修复 |
| **提交** | git-commit-hash（如可得） |
| **文件** | filepath:startLine-endLine |
| **原因** | [一句话原因，25字以内] |

## 问题

[问题现象，1-2段，80字以内]

**触发场景**：
- 场景 1：[简要说明]
- 场景 2：[简要说明]

## 解决方案

[解决方案描述，可含代码]

如涉及代码修改，提供修改前后对比或关键代码片段：

\`\`\`javascript
// 修改内容
var obj = something;
if (!cc.sys.isObjectValid(obj)) return;
\`\`\`

## 测试

验证清单：

- ✅ 测试项 1：[说明]
- ✅ 测试项 2：[说明]
- ✅ 测试项 3：[说明]

## 现场记录

原始飞书文档保留完整上下文：

👉 **[CV发版通知群 2025年10月30日](https://ghoststudio.feishu.cn/wiki/...)**
```

### 活动生成规则

```markdown
# [活动名称]

## 基本信息

| 属性 | 值 |
|-----|-----|
| **活动名** | [活动名称] |
| **时间** | [开始时间] ~ [结束时间] |
| **类型** | [签到/抽奖/赛事等] |
| **参与对象** | [新人/老人/全体玩家等] |

## 活动规则

[用自然语言描述活动规则，1-3段落]

关键约束条件：
- 条件 1
- 条件 2

## 奖励设置

| 等级/里程碑 | 奖励 | 数量/金额 |
|-----------|------|---------|
| 等级 1 | 奖品 1 | 数值 1 |
| 等级 2 | 奖品 2 | 数值 2 |

## 玩法说明

### 参与步骤

1. [步骤 1]
2. [步骤 2]
3. [步骤 3]

### 兑换说明

[如有兑换机制，说明兑换流程]

## 原始文档

👉 **[飞书文档](URL)**
```

### 关卡生成规则

```markdown
# [关卡名称/编号]

## 基本信息

| 属性 | 值 |
|-----|-----|
| **关卡号** | [编号] |
| **名称** | [名称] |
| **难度** | [1-5级] |
| **类型** | [关卡类型] |

## 功能说明

[关卡玩法机制描述，1-2段]

特殊机制：
- 机制 1：[说明]
- 机制 2：[说明]

## 数值配置

### 基础配置

| 配置项 | 默认值 | 说明 |
|-------|-------|------|
| 配置 1 | 值 1 | 说明 1 |
| 配置 2 | 值 2 | 说明 2 |

### 奖励配置

| 条件 | 奖励 | 倍率 |
|-----|------|------|
| 条件 1 | 奖励 1 | 1.0x |

## 文件位置

- 关卡逻辑：`src/game/level/Level.js:100-150`
- 配置文件：`src/game/level/config/level.json`
- UI 文件：`src/game/level/ui/LevelUI.js`

## 注意事项

- [注意 1]
- [注意 2]

## 原始文档

👉 **[飞书文档](URL)**
```

---

## 提交信息规范

### 格式

docs 子项目提交格式统一为：

```
docs: [类型] - [标题]
```

### 类型对应

| 文档类型 | 提交示例 |
|---------|---------|
| 故障排查 | `docs: 故障排查 - Coupon关卡-活动入口异常` |
| 活动 | `docs: 活动 - 新春签到活动` |
| 关卡 | `docs: 关卡 - 关卡100设计文档` |
| 其他 | `docs: 技术方案 - XXX架构设计` |

### title 部分规范

- 长度：20-50 字
- 不含特殊符号，仅允许 `-` 和空格
- 体现关键信息或关卡号

---

## 错误处理

### 权限错误

**症状**：
```
Access denied. One of the following scopes is required:
[wiki:wiki, wiki:wiki:readonly, wiki:node:read]
```

**解决**：
1. 检查 lark-mcp 配置的 App ID 和 Secret
2. 在飞书开发者后台申请权限
3. 权限包括：`wiki:wiki:readonly`, `docx:document:readonly`

**参考**：用户首次配置 lark-mcp 时已经历过，详见历史记录

---

### 链接无效

**症状**：
```
Wiki token not found or document deleted
```

**处理**：
1. 确认链接格式正确
2. 检查文档未被删除
3. 提示用户重新提供有效链接

---

### 类型识别失败

**症状**：自动识别无法确定文档类型

**处理**：
```
自动识别失败，请选择文档类型：

1️⃣ 故障排查 - 问题修复相关
2️⃣ 活动 - 活动设计相关
3️⃣ 关卡 - 关卡配置相关
4️⃣ 其他 - 其他类型文档

请选择 (1-4):
```

---

### 文件重名

**症状**：目标文件已存在

**处理**：
```
文件已存在: docs/故障排查/Coupon关卡-活动入口异常显示问题.md

选择处理方式：
1️⃣ 覆盖现有文件
2️⃣ 重命名为: xxx-v2.md
3️⃣ 取消操作
```

---

## 常见问题

### Q1：如何从群聊链接提取飞书文档？

**A**: 飞书群聊消息中可能包含文档链接。提取方式：

1. 从消息中识别 Wiki 链接（`https://ghoststudio.feishu.cn/wiki/xxxx`）
2. 或查看消息中"文档"、"链接"等引用
3. 直接提供给 Skill

示例：
```
在群聊消息中看到：
"问题详情见: https://ghoststudio.feishu.cn/wiki/FjqOwGH72izxYHkbgKgcUSEbnZb"

→ 直接提供链接：
/feishu-to-docs https://ghoststudio.feishu.cn/wiki/FjqOwGH72izxYHkbgKgcUSEbnZb
```

---

### Q2：飞书文档包含截图/视频，如何处理？

**A**: 当前策略：保留飞书原文档链接

- 不下载或转换媒体文件（复杂且易出错）
- 生成 Markdown 文档链接指向原飞书
- 用户需要完整信息时访问飞书原文档查看截图/视频

优点：
- 简化流程，降低出错风险
- 保持信息更新（飞书文档修改自动反映）
- 便于版本管理（原文档永久存档）

---

### Q3：同一文档可能属于多个类型，如何识别？

**A**: 按优先级判断

```
故障排查 > 活动 > 关卡 > 其他
```

即：如果既包含问题又包含活动信息，优先识别为故障排查。

如确实混合型文档，建议手动选择主要类型。

---

### Q4：生成文档后如何修改或删除？

**A**: 文档生成后的修改流程：

1. **修改内容**：
   - 直接编辑 Markdown 文件
   - 更新后 `git add` 和 `git commit`
   - 提交信息示例：`docs: 更新 - [文档名]`

2. **删除文档**：
   - 直接删除文件
   - 提交信息示例：`docs: 删除 - [文档名]`

---

### Q5：如何处理没有权限的飞书文档？

**A**:

1. **群聊分享文档**：
   - 检查是否有权限访问
   - 权限缺失时，提示用户申请
   - 或让文档所有者分享权限

2. **个人文档**：
   - 向文档所有者请求权限
   - 或提供文档内容截图（手动处理）

---

## 参考资源

- **Skill 完整规范**: `.claude/skills/feishu-to-docs/SKILL.md`
- **VitePress 规范**: `docs/工程-工具/ai-rules/docs/vitepress.md`
- **文档分类规范**: `CLAUDE.md > 文档记录原则`
- **Git 提交规范**: `.claude/skills/git-commit/SKILL.md`
- **lark-mcp 文档**: https://github.com/larksuiteoapi/lark-mcp

---

**最后更新**: 2025-10-31
**维护者**: WorldTourCasino Team
