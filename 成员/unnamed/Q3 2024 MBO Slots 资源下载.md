# 扩包Loading优化&活动资源后置下载

由于slots首次进入游戏loading时间较长，体验不好，所以进行加载优化，优化分两部分：扩包+活动资源后置下载

# 扩包

目前线上release包，包内放置的资源量较少，**android 100M左右，ios 150M左右**。玩家首次启动应用需要热更下载相当一部分的资源量，导致loading时间较长。  
扩包方案就是在放置一些常驻的系统资源和高频的活动资源，laoding阶段无需再次下载。

### 方案执行(初版只做ios平台)

修改**resource\_dirs.json**配置文件,将**iosNativeDirs**字段配置成**常驻资源+高频活动资源**,打包的时候会读取该字段的配置将资源打入包内**。**

### 测试数据

ios扩包:常驻资源 \+ 高频活动资源  
debug包体:333M  
测试服:821版本资源   
设备:phone 13  
**loading时长:37s 29s 29s**

release扩包版本:  
包体:335M  
设备:phone 13  
**loading时长:80s 66s 105s**

release线上版本:  
包体:145M  
设备:phone 13  
**loading时长:413s  404s**

### 方案总结&问题

1、上面测试数据可以看出，扩包方案减少了50%\~75%的loading时长，该方案针对新下载玩家有效  
2、ios初版上线跑测检测下玩家实际网络环境的下的优化速度，如果没有问题，开始着手andoird的扩包方案制定和执行

# 活动资源后置下载

为了进一步提升性能，减少loading时长，特制定活动资源后置下载方案。之前的loading阶段会下载未来两周的活动资源，资源量较大耗时较长。后置下载方案则将活动资源  
下载时机放到玩家进入大厅以后动态下载，且只下载当前开启的活动资源。

### 方案执行

#### 1、修改**resource\_dirs.json，**添加活动资源后置下载字段配置**lagLoadActivityDirs**

    ![0][image1]

#### 2、获取到活动数据后，将活动资源路径加入到下载队列中

    ![0][image2]

#### 3、玩家进入大厅后，开启资源下载

    ![0][image3]

### 测试数据

ios扩包:常驻资源 \+ 高频活动资源+未来两周活动资源后置下载  
debug包体:333M  
测试服:821版本资源   
设备:phone 13  
**loading时长:10s 8s**

### 方案总结&问题

**该方案遇到问题较多，需要对各个活动进行逻辑校正，持续时间较长，踩坑较多，保持心态尤为重要！！！**  
**1、宣发类问题**  
**2、弹板类问题**  
**3、关卡内问题**  
**4、回到大厅补单弹板类问题**  
**5、deal类活动刷新问题**  
**6、二次加载刷新问题**  
**7、活动初始化问题**  
**8、下载时长问题**

#### 1、宣发类问题

策划需求在没有活动资源的情况下也要展示宣发广告牌等，跳转提示downloading。跟现有逻辑冲突点在于后置下载的活动在没有下载完资源的情况下是不初始化活动数据的，没有活动数据则不展示宣发，且宣发有可能绑定了控件需要读取活动数据。  
**方案:**缓存一套后置下载的活动数据，展示宣发或者跳转的时候走之前的验证逻辑，如果没有活动数据则去缓存里面去找

    ![0][image4]

#### 2、弹板类问题

弹板类问题较为复杂，之前触发弹板分两个大类，after\_login 和 back\_to\_lobby,后置下载的活动需要等资源下载完成后再弹出，下载完成的时机这里又分为两个情况：在大厅下载完成和在关卡下载完成。  
**方案:**在大厅下载完成的话，需要再没有弹窗弹出的时候重新触发下after\_login类弹板，同时剔除已经弹出过的板子。在关卡下载完成的话，回到大厅先触发一下after\_login类弹板，再触发一下back\_to\_lobby类弹板，同时剔除重复的和已经弹出过的弹板

    ![0][image5]

    ![0][image6]

    ![0][image7]

#### 3、关卡内问题

关卡内初始化活动入口的时候会有入口无数据填充时候的状态，详情请看MagicRivalsWidgetController和TeamRankingsWidgetController

#### 4、回到大厅补单弹板类问题

之前部分活动的弹板直接在活动内做了，没有走弹板逻辑，本次修改加入到了4005及2000的弹板类型里

    ![0][image8]

#### 5、deal类活动刷新问题

**deal类活动在资源下载完成后需要发送一个deal类刷新事件刷新资源栏按钮状态**

    ![0][image9]

#### 6、二次加载刷新问题

在进入游戏的时候会获取下活动数据，在后置下载完成后也会重新请求下数据然后刷新，此时如果打开了已经有的活动界面会造成某种异常，比如界面无法关闭以及数据丢失的问题  
**方案:**资源下载完成后只刷新当前后置部分的活动数据

    ![0][image10]

#### 7、活动初始化问题

部分老活动在initActivity接口里根据条件直接弹出了弹板，如果是后置下载没有资源的情况下会有异常。  
**方案：**弹板逻辑放入弹板池内，如WinnerSlotsActivity

#### 8、下载时长问题

目前游戏进入大厅需要先下载广告牌宣发等资源，下载完成后才去下载后置活动资源，耗时较长，如果并行下载则会太卡，后续考虑优化一下

### 反思&优化

**该方案执行过程中，需要对每个活动的逻辑做适配，而且问题很多，打了很多补丁，后续维护成本较高。究其原因是现有的活动逻辑结构不适用于走后置加载，需要重构一部分逻辑，比如活动初始化、弹板、补单等逻辑框架，解耦部分逻辑间的关联。后续会持续关注调研这块的优化方向，制定可执行的方案。**  




















