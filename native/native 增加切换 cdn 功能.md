# native 增加切换 cdn 功能

![image](/assets/1758174593056_a1517c63.png)

<span data-type="text" style="color: var(--b3-font-color2);">修订人：</span> 赵恒			修订时间：2025.4.28

版本节点：e2983b3b40af9e19af4a23282316af80a0139603

投放分支：classic_vegas_cvs_v817

## 一、概念：

---

正式资源服：打完版本后，资源 upload 位置，玩家不可见，等待发布到 CDN；（release 资源）

CDN：分发加速服务，发布到 CDN 后，玩家可见，即线上资源；（release 资源）

‍

切到正式 CDN：屏蔽本包原有资源获取方式，从 CDN 获取资源，连接正式服；

切到正式资源服：屏蔽本包原有资源获取方式，从正式资源服获取资源，连接正式服；

关闭切换：关闭切换标记，恢复本包原有资源获取方式，debug 的连接测试服，release 包连接正式服；

  

## 二、解决的问题：

---

#### 支持测试包直连资源服或cdn，正式包直连资源服，以实现：

1. 未来不停服更新时，支持 “QA 验证服” 阶段、提前获取最新资源版本；

2. 以后资源更新在推送到 cdn 正式分发之前，先校验资源、版本，避免推送到 cdn 的资源、版本异常；

3. 解决 release 包无日志打印、不方便查问题的情况；
4. 可避免因 debug、release 包不能同时安装，QA 、策划等频繁换包；

‍

## 三、实现方案：

---

1. native debug 面板增加切换 cdn 地址按钮：

    ![image](/assets/1758174593057_56f9159e.png)
2. native debug、release VIP 信息界面增加隐藏点击序列，触发 cdn 地址切换：

    ![image](/assets/1758174593059_b934d2ab.png)

    1. 切换到正式资源服：（1212121）
    2. 关闭切换：（1111111）
3. cdn 地址切换实现：

    1. 本地存储标记 resourceServerSelectState：1（切换到正式资源服），2（切到正式 CDN），0（关闭切换）
    2. 按标记写死对应资源地址；
    3. Config.js 中添加标记判断，返回修正后的资源地址；
    4. 打完标记后强制退出 app；

‍

## 四、测试注意：

---

1. debug 包，debug 面板和 vip 信息界面操作序列都可用；

    可切换到正式资源服 或 CDN；
2. release 包，vip 信息界面操作序列可用；

    1. 【只可】切换到正式资源服；
    2. 需要将代码发布到线上后，release 包才可用该功能；
3. 来回切换，不卡 laoding、版本正确、不丢失资源；

‍
